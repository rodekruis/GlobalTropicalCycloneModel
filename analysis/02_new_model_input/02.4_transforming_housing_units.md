# Re-scaling buildings to Household Units

```python
%load_ext jupyter_black
import pandas as pd
import os
from pathlib import Path
```

```python
base_url = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis/02_new_model_input/02_housing_damage/"
)
input_dir = base_url / "input/Google Footprint Data/"
```

```python
phl_ggl_bld_municip_count = pd.read_csv(
    input_dir / "phl_google_bld_municip_count.csv"
)
phl_ggl_bld_grid_count = pd.read_csv(
    input_dir / "phl_google_bld_grid_count.csv"
)
phl_ggl_bld_intersection_count = pd.read_csv(
    input_dir / "phl_google_bld_intersection_count.csv"
)
```

## Computing weights

### Municipality to Grid

```python
mun_to_grid = phl_ggl_bld_intersection_count.merge(
    phl_ggl_bld_municip_count, on="ADM3_PCODE", suffixes=("_x", None)
)
mun_to_grid["weight"] = (
    mun_to_grid["numbuildings_x"] / mun_to_grid["numbuildings"]
)
mun_to_grid[mun_to_grid["Centroid"] == "122.1E_17.4N"]
```

```python
mun_to_grid.to_csv(input_dir / "ggl_mun_to_grid_weights.csv", index=False)
```

### Grid to Municipality

```python
grid_to_mun = phl_ggl_bld_intersection_count.merge(
    phl_ggl_bld_grid_count, on="Centroid", suffixes=("_x", None)
)
grid_to_mun["weight"] = (
    grid_to_mun["numbuildings_x"] / grid_to_mun["numbuildings"]
)
grid_to_mun.groupby("Centroid").sum().sort_values(by="weight")
```

```python
grid_to_mun.to_csv(input_dir / "ggl_grid_to_mun_weights.csv", index=False)
```

## Re-scaling number of buildings with Housing Units data

The housing units data is from `https://data.humdata.org/dataset/philippines-pre-disaster-indicators`

- File URL `https://data.humdata.org/dataset/f26a0a04-0549-4139-af91-81dfa6e56082/resource/557b601f-e2f5-42ef-8742-e47395427384/download/180814_construction-materials-of-the-outer-walls-and-roof_by-city_municipality.xlsx`

```python
construction_materials_df = pd.read_excel(
    base_url
    / "input/180814_construction-materials-of-the-outer-walls-and-roof_by-city_municipality.xlsx",
    sheet_name="by category",
)
```

```python
housing_units_df = construction_materials_df[
    ["Municipality_City Code", "Housing Units"]
]
# using right join to preserve all municipalities
hu_grid = housing_units_df.merge(
    mun_to_grid[["ADM3_PCODE", "id", "Centroid", "weight"]],
    how="right",
    left_on="Municipality_City Code",
    right_on="ADM3_PCODE",
)
hu_grid["hu_bygrid"] = hu_grid["Housing Units"] * hu_grid["weight"]
hu_grid = hu_grid.groupby(["id", "Centroid"]).sum().reset_index()
hu_grid.drop(["Housing Units", "weight"], axis=1, inplace=True)
```

```python
rescaled_df = phl_ggl_bld_grid_count.merge(hu_grid, on=["id", "Centroid"])
rescaled_df["normalisation"] = (
    rescaled_df["numbuildings"] - min(rescaled_df["numbuildings"])
) / (max(rescaled_df["numbuildings"]) - min(rescaled_df["numbuildings"]))
```

```python
rescaled_df["numbuildings_rescaled"] = (
    (max(rescaled_df["hu_bygrid"]) - min(rescaled_df["hu_bygrid"]))
    * rescaled_df["normalisation"]
) + min(rescaled_df["hu_bygrid"])
rescaled_df
```

```python
rescaled_df.to_csv(input_dir / "rescaled_blds_bygrid.csv", index=False)
```
